<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Department Job Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Inter Font and Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .dim-input {
            width: 80px; /* Specific width for dimension parts */
        }
        .quantity-input {
            width: 60px; /* Specific width for quantity */
        }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Style for the authentication modal overlay */
        #auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* Hide print button when printing */
        @media print {
            #form-container, h2.mb-4, #loading-jobs, #empty-state, .edit-job-btn, .delete-job-btn, .print-job-btn, #auth-btn {
                display: none !important;
            }
            .job-card {
                margin: 0;
                border: none;
                box-shadow: none;
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <header class="text-center mb-10 relative">
            <h1 class="text-4xl font-extrabold text-blue-800 tracking-tight">Department Job Tracker</h1>
            <p class="text-gray-600 mt-1">Track items, dimensions, quantities, and departmental notes in real-time.</p>
            
            <div class="absolute top-0 right-0 mt-2 flex items-center space-x-3">
                <div id="auth-status" class="text-xs text-gray-500 hidden md:block">
                    Loading authentication...
                </div>
                <button id="auth-btn" class="p-2 text-xs md:text-sm font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-150 shadow-md">
                    User Authentication
                </button>
            </div>
        </header>

        <!-- Main Content Area: Job Creation/Editing Form -->
        <div id="form-container" class="bg-white p-6 md:p-8 rounded-xl card-shadow mb-10">
            <h2 id="form-title" class="text-2xl font-semibold text-gray-800 mb-4">Create New Job</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Column 1: Job Details -->
                <div class="md:col-span-1">
                    <label for="job-name" class="block text-sm font-medium text-gray-700 mb-1">Job Name / ID</label>
                    <input type="text" id="job-name" placeholder="Enter Job Name (e.g., Project Atlas 001)"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">

                    <label class="block text-lg font-semibold text-gray-800 mt-6 mb-2">Item Details</label>
                    <div id="item-list" class="space-y-4">
                        <!-- Item fields will be injected here -->
                    </div>
                    <button id="add-item-btn" class="mt-4 w-full flex items-center justify-center p-2 text-sm font-medium text-blue-700 bg-blue-100 rounded-lg hover:bg-blue-200 transition duration-150">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Add Item
                    </button>
                </div>

                <!-- Column 2 & 3: Department Notes -->
                <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label for="graphics-notes" class="block text-sm font-bold mb-1 text-green-700">Graphics Department Notes</label>
                        <textarea id="graphics-notes" rows="6" placeholder="Notes on file formats, color profiles, revisions, etc."
                                  class="w-full p-3 border-2 border-green-200 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 bg-green-50"></textarea>
                    </div>
                    <div>
                        <label for="production-notes" class="block text-sm font-bold mb-1 text-red-700">Production Department Notes</label>
                        <textarea id="production-notes" rows="6" placeholder="Notes on machine setup, material type, finishing, cutting, etc."
                                  class="w-full p-3 border-2 border-red-200 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150 bg-red-50"></textarea>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <button id="cancel-edit-btn" class="hidden p-3 text-sm font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">Cancel Edit</button>
                <button id="save-job-btn" class="p-3 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150">
                    <span id="save-btn-text">Save Job</span>
                </button>
            </div>
        </div>

        <!-- Job List Area -->
        <h2 class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2">Active Jobs</h2>
        <div id="job-list-container" class="space-y-4">
            <!-- Jobs will be loaded here -->
            <p id="loading-jobs" class="text-gray-500 text-center p-8">Loading jobs...</p>
        </div>
        <div id="empty-state" class="hidden bg-yellow-50 p-6 rounded-lg border border-yellow-200 mt-4 text-center">
            <p class="text-yellow-800 font-medium">No jobs found. Start by creating a new job above!</p>
        </div>

    </div>

    <!-- Authentication Modal (Hidden by default) -->
    <div id="auth-modal" class="hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 id="auth-modal-title" class="text-2xl font-bold text-gray-800 mb-4 text-center">Sign In / Sign Up</h3>
            
            <form id="auth-form" onsubmit="return false;" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="auth-email" placeholder="you@company.com" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="auth-password" placeholder="Min 6 characters" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div id="auth-message" class="text-sm text-center text-red-500 font-medium h-4"></div>

                <div class="flex space-x-3">
                    <button id="signin-btn" type="submit" class="flex-1 p-3 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150">
                        Sign In
                    </button>
                    <button id="signup-btn" type="button" class="flex-1 p-3 text-sm font-semibold text-blue-700 bg-blue-100 rounded-lg hover:bg-blue-200 transition duration-150">
                        Sign Up
                    </button>
                </div>
                <button id="close-modal-btn" type="button" class="w-full mt-4 text-gray-500 hover:text-gray-700 transition duration-150 text-sm">Close</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and App Variables
        let app;
        let db;
        let auth;
        let userId = 'anonymous';
        let currentEditingJobId = null;

        // UI Elements
        const authStatusEl = document.getElementById('auth-status');
        const authBtn = document.getElementById('auth-btn');
        const authModal = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authMessageEl = document.getElementById('auth-message');
        const signInBtn = document.getElementById('signin-btn');
        const signUpBtn = document.getElementById('signup-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        
        const jobNameInput = document.getElementById('job-name');
        const graphicsNotesInput = document.getElementById('graphics-notes');
        const productionNotesInput = document.getElementById('production-notes');
        const itemListContainer = document.getElementById('item-list');
        const addItemBtn = document.getElementById('add-item-btn');
        const saveJobBtn = document.getElementById('save-job-btn');
        const saveBtnText = document.getElementById('save-btn-text');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const jobListContainer = document.getElementById('job-list-container');
        const loadingJobsEl = document.getElementById('loading-jobs');
        const emptyStateEl = document.getElementById('empty-state');
        const formTitleEl = document.getElementById('form-title');

        // --- Authentication Functions ---

        /**
         * Toggles the visibility of the authentication modal.
         */
        const toggleAuthModal = () => {
            if (auth.currentUser && !auth.currentUser.isAnonymous) {
                // If a recognized user is logged in, treat the button as Sign Out
                handleSignOut();
            } else {
                // Otherwise, show the sign-in/sign-up modal
                authModal.classList.toggle('hidden');
                authModal.style.display = authModal.classList.contains('hidden') ? 'none' : 'flex';
                authMessageEl.textContent = ''; // Clear previous messages
            }
        };

        /**
         * Clears the authentication form fields.
         */
        const clearAuthForm = () => {
            authEmailInput.value = '';
            authPasswordInput.value = '';
        };

        /**
         * Handles user sign up with email and password.
         */
        const handleSignUp = async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authMessageEl.textContent = 'Creating account...';
            signInBtn.disabled = true;
            signUpBtn.disabled = true;

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                authMessageEl.textContent = 'Sign up successful! You are now logged in.';
                clearAuthForm();
                setTimeout(() => toggleAuthModal(), 1500); // Close modal after success
            } catch (error) {
                console.error("Sign up error:", error);
                authMessageEl.textContent = `Sign Up Failed: ${error.message.substring(0, 50)}...`;
            } finally {
                signInBtn.disabled = false;
                signUpBtn.disabled = false;
            }
        };

        /**
         * Handles user sign in with email and password.
         */
        const handleSignIn = async (event) => {
            event.preventDefault(); // Prevent default form submission if triggered by form submit
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authMessageEl.textContent = 'Signing in...';
            signInBtn.disabled = true;
            signUpBtn.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                authMessageEl.textContent = 'Sign in successful!';
                clearAuthForm();
                setTimeout(() => toggleAuthModal(), 1500); // Close modal after success
            } catch (error) {
                console.error("Sign in error:", error);
                authMessageEl.textContent = `Sign In Failed: ${error.message.substring(0, 50)}...`;
            } finally {
                signInBtn.disabled = false;
                signUpBtn.disabled = false;
            }
        };

        /**
         * Handles user sign out.
         */
        const handleSignOut = async () => {
            try {
                await signOut(auth);
                // Immediately sign in anonymously again to keep the app functional
                await signInAnonymously(auth);
                // The onAuthStateChanged listener will update the UI
            } catch (error) {
                console.error("Sign out error:", error);
                // Using a non-modal message for error reporting
                alert(`Sign Out Failed: ${error.message}`);
            }
        };

        // --- Utility Functions ---

        /**
         * Generates the HTML for a single item input row.
         * @param {Object} itemData - The data for the item (optional for new items).
         * @returns {string} The HTML string.
         */
        const generateItemInput = (itemData = { name: '', dimL: '', dimW: '', dimH: '', unit: 'in', quantity: 1, id: crypto.randomUUID() }) => {
            const itemId = itemData.id || crypto.randomUUID();
            const { name, dimL, dimW, dimH, unit, quantity } = itemData;

            return `
                <div class="item-input-row flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-2 bg-gray-50 p-3 rounded-lg border border-gray-200" data-id="${itemId}">
                    <!-- Item Name -->
                    <input type="text" class="flex-grow p-1 border border-gray-300 rounded-md text-sm" placeholder="Item Name (e.g., Banner, Box)" value="${name}" data-field="name">

                    <!-- Dimension L x W x H -->
                    <div class="flex items-center space-x-1 text-sm">
                        <input type="number" class="dim-input p-1 border border-gray-300 rounded-md text-sm" placeholder="L" value="${dimL}" data-field="dimL">
                        <span>x</span>
                        <input type="number" class="dim-input p-1 border border-gray-300 rounded-md text-sm" placeholder="W" value="${dimW}" data-field="dimW">
                        <span>x</span>
                        <input type="number" class="dim-input p-1 border border-gray-300 rounded-md text-sm" placeholder="H" value="${dimH}" data-field="dimH">
                        <select class="p-1 border border-gray-300 rounded-md text-sm" data-field="unit">
                            <option value="in" ${unit === 'in' ? 'selected' : ''}>in</option>
                            <option value="cm" ${unit === 'cm' ? 'selected' : ''}>cm</option>
                            <option value="ft" ${unit === 'ft' ? 'selected' : ''}>ft</option>
                        </select>
                    </div>

                    <!-- Quantity -->
                    <div class="flex items-center space-x-1">
                        <input type="number" class="quantity-input p-1 border border-gray-300 rounded-md text-sm" placeholder="Qty" value="${quantity}" data-field="quantity" min="1">
                        <!-- Remove Button -->
                        <button type="button" class="remove-item-btn p-1 text-red-500 hover:text-red-700 transition duration-150" data-id="${itemId}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3m-3 0h10"></path></svg>
                        </button>
                    </div>
                </div>
            `;
        };

        /**
         * Renders the item input rows based on the current job data.
         * @param {Array<Object>} items - Array of item objects.
         */
        const renderItemInputs = (items = []) => {
            itemListContainer.innerHTML = items.map(generateItemInput).join('');
            if (items.length === 0) {
                // Ensure at least one item is present when starting fresh
                addItemInput();
            }
        };

        /**
         * Adds a new, empty item input row.
         */
        const addItemInput = () => {
            itemListContainer.insertAdjacentHTML('beforeend', generateItemInput());
            attachItemListeners();
        };

        /**
         * Extracts data from all item input rows in the form.
         * @returns {Array<Object>} Array of formatted item objects.
         */
        const getItemsData = () => {
            const itemRows = document.querySelectorAll('.item-input-row');
            const items = [];

            itemRows.forEach(row => {
                const id = row.dataset.id;
                const name = row.querySelector('[data-field="name"]').value.trim();
                const dimL = parseFloat(row.querySelector('[data-field="dimL"]').value) || 0;
                const dimW = parseFloat(row.querySelector('[data-field="dimW"]').value) || 0;
                const dimH = parseFloat(row.querySelector('[data-field="dimH"]').value) || 0;
                const unit = row.querySelector('[data-field="unit"]').value;
                const quantity = parseInt(row.querySelector('[data-field="quantity"]').value) || 1;

                if (name || dimL > 0 || dimW > 0 || dimH > 0 || quantity > 0) {
                    items.push({
                        id,
                        name: name || 'Unnamed Item',
                        dimension: `${dimL} x ${dimW} x ${dimH} ${unit}`, // Store as combined string
                        dimL, dimW, dimH, unit, // Store individual parts for easier editing
                        quantity: Math.max(1, quantity)
                    });
                }
            });
            return items;
        };

        /**
         * Converts the stored item object back into the format used by the input fields.
         * @param {Object} item - The item object from Firestore.
         * @returns {Object} The item object formatted for input rendering.
         */
        const formatItemForInput = (item) => {
            // If the item already has individual dim fields (from a newer version) use them
            if (item.dimL !== undefined) {
                return item;
            }

            // Simple parsing logic for legacy dimension string: "L x W x H unit"
            const parts = item.dimension.split(' ');
            let dimL = '', dimW = '', dimH = '', unit = 'in';

            if (parts.length >= 5) {
                dimL = parts[0];
                dimW = parts[2];
                dimH = parts[4];
                unit = parts[5] || 'in';
            }

            return {
                ...item,
                dimL: dimL,
                dimW: dimW,
                dimH: dimH,
                unit: unit,
            };
        };
        
        /**
         * Generates and triggers the print functionality for a specific job report.
         * @param {Object} job - The job data object.
         */
        const printJobReport = (job) => {
            // 1. Create the content structure for the print report
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Job Report: ${job.jobName}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
                        body { font-family: 'Inter', sans-serif; margin: 0; padding: 20px; color: #333; }
                        h1 { color: #1e40af; font-size: 24px; border-bottom: 2px solid #bfdbfe; padding-bottom: 10px; margin-bottom: 20px; }
                        h2 { font-size: 18px; color: #1f2937; margin-top: 20px; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; }
                        .section { margin-bottom: 20px; page-break-inside: avoid; }
                        .item-list { list-style: none; padding: 0; }
                        .item-list li { background: #f9fafb; padding: 10px; border-radius: 4px; margin-bottom: 8px; border: 1px solid #e5e7eb; }
                        .item-name { font-weight: bold; margin-bottom: 4px; color: #1e40af; }
                        .item-details { font-size: 14px; color: #4b5563; }
                        .notes-container { display: flex; gap: 20px; margin-top: 15px; }
                        .note-box { flex: 1; padding: 15px; border-radius: 8px; }
                        .note-box h3 { font-size: 16px; margin-top: 0; margin-bottom: 5px; font-weight: 700; }
                        .graphics-note { background-color: #ecfdf5; border: 1px solid #a7f3d0; }
                        .production-note { background-color: #fef2f2; border: 1px solid #fecaca; }
                        .note-content { white-space: pre-wrap; font-size: 14px; color: #374151; }
                        .footer { text-align: center; margin-top: 40px; font-size: 12px; color: #6b7280; }

                        /* Print specific styles */
                        @media print {
                            body { background: white !important; }
                            .notes-container { display: block; }
                            .note-box { margin-bottom: 15px; }
                            .item-list li { border: 1px solid #ddd; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Job Report: ${job.jobName}</h1>

                    <div class="section">
                        <h2>Items</h2>
                        <ul class="item-list">
                            ${job.items.map(item => `
                                <li>
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-details">
                                        Quantity: <span style="font-weight: 600;">${item.quantity}</span> |
                                        Dimensions: <span style="font-weight: 600;">${item.dimension}</span>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>

                    <div class="section">
                        <h2>Departmental Notes</h2>
                        <div class="notes-container">
                            <div class="note-box graphics-note">
                                <h3>Graphics Department Notes</h3>
                                <div class="note-content">${job.graphicsNotes || 'No notes provided.'}</div>
                            </div>
                            <div class="note-box production-note">
                                <h3>Production Department Notes</h3>
                                <div class="note-content">${job.productionNotes || 'No notes provided.'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="footer">
                        Report generated on: ${new Date().toLocaleString()} | Job ID: ${job.id.substring(0, 8)}
                    </div>
                </body>
                </html>
            `;

            // 2. Create a temporary, hidden iframe
            let printFrame = document.createElement('iframe');
            printFrame.style.visibility = 'hidden';
            printFrame.style.position = 'absolute';
            printFrame.style.left = '-1000px'; // Move off-screen
            printFrame.src = 'about:blank'; // Required for security in some browsers

            document.body.appendChild(printFrame);

            // 3. Write content to the iframe and trigger print
            printFrame.onload = function() {
                let doc = printFrame.contentWindow.document;
                doc.open();
                doc.write(printContent);
                doc.close();

                // Wait for content to render before printing
                setTimeout(() => {
                    printFrame.contentWindow.focus();
                    printFrame.contentWindow.print();
                    
                    // Clean up the iframe after printing is initiated
                    setTimeout(() => {
                        document.body.removeChild(printFrame);
                    }, 1000); // Give the print dialog time to show up
                }, 300);
            };
        };


        // --- Core Application Logic ---

        /**
         * Initializes Firebase and handles authentication.
         */
        const setupFirebase = async () => {
            try {
                // Ensure variables are defined in the environment
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (Object.keys(firebaseConfig).length === 0) {
                    authStatusEl.textContent = 'ERROR: Firebase configuration is missing.';
                    console.error('Firebase config is missing.');
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in using the custom token or anonymously
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for Auth State changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        const userDisplay = user.isAnonymous ? 'Anonymous User' : (user.email || user.uid);
                        
                        authStatusEl.innerHTML = `<span class="font-medium text-gray-700">User:</span> <span class="text-sm font-mono text-blue-600">${userDisplay}</span>`;
                        authStatusEl.classList.remove('hidden');
                        
                        // FIX: Safely determine the display name for the sign out button
                        let emailPrefix = 'User';
                        if (user.email) {
                            emailPrefix = user.email.split('@')[0];
                        }

                        if (user.isAnonymous) {
                            authBtn.textContent = 'Sign In / Sign Up';
                            authBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                            authBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        } else {
                            // Use the safely determined emailPrefix
                            authBtn.textContent = `Sign Out (${emailPrefix})`; 
                            authBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                            authBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                        }

                        loadJobs(); // Start loading data only after auth is ready
                    } else {
                        // Signed out
                        authStatusEl.textContent = 'Signed out.';
                        authBtn.textContent = 'Sign In / Sign Up';
                        authBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                        authBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    }
                });

            } catch (error) {
                authStatusEl.textContent = `Authentication Error: ${error.message}`;
                console.error("Firebase setup failed:", error);
            }
        };

        /**
         * Handles saving a new job or updating an existing one to Firestore.
         */
        const saveJob = async () => {
            const jobName = jobNameInput.value.trim();
            const graphicsNotes = graphicsNotesInput.value.trim();
            const productionNotes = productionNotesInput.value.trim();
            const items = getItemsData();

            if (!jobName) {
                // Using a custom modal style prompt instead of alert/confirm
                // Using alert here since we cannot use a full modal component
                alert('Please enter a Job Name / ID.'); 
                return;
            }

            if (items.length === 0) {
                 // Using alert here since we cannot use a full modal component
                alert('Please add at least one item.');
                return;
            }

            const jobId = currentEditingJobId || crypto.randomUUID();
            // Data is public so all users can see/edit jobs
            const jobRef = doc(db, `artifacts/${__app_id}/public/data/jobs`, jobId);

            const jobData = {
                jobName,
                graphicsNotes,
                productionNotes,
                items,
                createdBy: auth.currentUser?.email || 'Anonymous', // Store the user identity
                userId: userId,
                updatedAt: serverTimestamp(),
            };

            saveJobBtn.disabled = true;
            saveBtnText.textContent = currentEditingJobId ? 'Updating...' : 'Saving...';

            try {
                await setDoc(jobRef, jobData);
                resetForm();
                console.log('Job saved successfully:', jobId);
            } catch (error) {
                console.error('Error saving job:', error);
                 // Using alert here since we cannot use a full modal component
                alert('Failed to save job. Check console for details.');
            } finally {
                saveJobBtn.disabled = false;
                saveBtnText.textContent = 'Save Job';
            }
        };

        /**
         * Sets up a real-time listener to fetch all jobs.
         */
        const loadJobs = () => {
            if (!db) return;

            const jobsCollectionRef = collection(db, `artifacts/${__app_id}/public/data/jobs`);
            const q = query(jobsCollectionRef);

            onSnapshot(q, (snapshot) => {
                const jobs = [];
                snapshot.forEach(doc => {
                    jobs.push({ id: doc.id, ...doc.data() });
                });

                renderJobs(jobs);
                loadingJobsEl.classList.add('hidden');
                if (jobs.length === 0) {
                    emptyStateEl.classList.remove('hidden');
                    jobListContainer.innerHTML = '';
                } else {
                    emptyStateEl.classList.add('hidden');
                }
            }, (error) => {
                console.error("Error loading jobs:", error);
                jobListContainer.innerHTML = `<p class="text-red-500 p-4">Error loading jobs: ${error.message}</p>`;
            });
        };

        /**
         * Renders the list of jobs fetched from Firestore.
         * @param {Array<Object>} jobs - The list of job objects.
         */
        const renderJobs = (jobs) => {
            // Sort by latest update time (descending)
            jobs.sort((a, b) => (b.updatedAt?.toDate()?.getTime() || 0) - (a.updatedAt?.toDate()?.getTime() || 0));

            jobListContainer.innerHTML = jobs.map(job => {
                const lastUpdate = job.updatedAt ? job.updatedAt.toDate().toLocaleString() : 'N/A';
                const createdBy = job.createdBy || 'Unknown';
                const itemSummary = job.items.map(i => `${i.quantity}x ${i.name}`).join(', ') || 'No items defined';

                return `
                    <div class="job-card bg-white p-6 rounded-xl border-l-4 ${job.graphicsNotes.length > 0 || job.productionNotes.length > 0 ? 'border-blue-500' : 'border-gray-200'} card-shadow">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                            <h3 class="text-xl font-bold text-gray-900 truncate pr-4">${job.jobName}</h3>
                            <div class="mt-2 md:mt-0 flex items-center space-x-2">
                                <span class="text-xs text-gray-500 mr-2">Created by: ${createdBy}</span>
                                <span class="text-xs text-gray-500">Last Update: ${lastUpdate}</span>
                                <button data-job-id="${job.id}" class="print-job-btn p-2 text-sm font-semibold text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0V9a1 1 0 011-1h6a1 1 0 011 1v8m-10 0h10"></path></svg>
                                </button>
                                <button data-job-id="${job.id}" class="edit-job-btn p-2 text-sm font-semibold text-blue-600 bg-blue-100 rounded-lg hover:bg-blue-200 transition duration-150">
                                    View / Edit
                                </button>
                                <button data-job-id="${job.id}" class="delete-job-btn p-2 text-sm font-semibold text-red-600 bg-red-100 rounded-lg hover:bg-red-200 transition duration-150">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3m-3 0h10"></path></svg>
                                </button>
                            </div>
                        </div>

                        <p class="text-sm text-gray-600 mt-2 line-clamp-1">Items: ${itemSummary}</p>

                        <div class="details-${job.id} hidden mt-4 border-t pt-4">
                            <h4 class="text-base font-semibold mb-2">Item List:</h4>
                            <ul class="space-y-2 text-sm">
                                ${job.items.map(item => `
                                    <li class="p-2 bg-gray-50 rounded-md flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                        <span class="font-medium text-gray-800">${item.name}</span>
                                        <span class="text-gray-600">
                                            <span class="font-bold">${item.quantity}</span> units,
                                            Dimensions: <span class="font-mono text-xs text-blue-700">${item.dimension}</span>
                                        </span>
                                    </li>
                                `).join('')}
                            </ul>
                            
                            <!-- Departmental Notes Section -->
                            <h4 class="text-base font-semibold mt-6 mb-3 border-t pt-4">Departmental Notes:</h4>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                                <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                                    <p class="font-bold text-green-700 mb-1">Graphics Notes:</p>
                                    <p class="whitespace-pre-wrap text-gray-700">${job.graphicsNotes || 'No notes yet.'}</p>
                                </div>
                                <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                                    <p class="font-bold text-red-700 mb-1">Production Notes:</p>
                                    <p class="whitespace-pre-wrap text-gray-700">${job.productionNotes || 'No notes yet.'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Re-attach event listeners after rendering
            attachJobListeners(jobs);
        };

        /**
         * Populates the form fields for editing an existing job.
         * @param {Object} job - The job data object.
         */
        const editJob = (job) => {
            currentEditingJobId = job.id;
            jobNameInput.value = job.jobName;
            graphicsNotesInput.value = job.graphicsNotes || '';
            productionNotesInput.value = job.productionNotes || '';

            // Format items for the input fields and render them
            const itemsForInput = (job.items || []).map(formatItemForInput);
            renderItemInputs(itemsForInput);

            formTitleEl.textContent = `Editing Job: ${job.jobName}`;
            saveBtnText.textContent = 'Update Job';
            cancelEditBtn.classList.remove('hidden');

            // Scroll to the top form for editing
            document.getElementById('form-container').scrollIntoView({ behavior: 'smooth' });
        };

        /**
         * Resets the form to the default state (creating a new job).
         */
        const resetForm = () => {
            currentEditingJobId = null;
            jobNameInput.value = '';
            graphicsNotesInput.value = '';
            productionNotesInput.value = '';
            formTitleEl.textContent = 'Create New Job';
            saveBtnText.textContent = 'Save Job';
            cancelEditBtn.classList.add('hidden');
            renderItemInputs(); // Render default single item
        };

        /**
         * Deletes a job from Firestore.
         * @param {string} jobId - The ID of the job to delete.
         */
        const deleteJob = async (jobId) => {
            // Using a custom modal style prompt instead of alert/confirm
            const jobName = document.querySelector(`.edit-job-btn[data-job-id="${jobId}"]`).closest('.job-card').querySelector('h3').textContent;
            if (window.confirm(`Are you sure you want to delete the job "${jobName}"? This cannot be undone.`)) {
                try {
                    const jobRef = doc(db, `artifacts/${__app_id}/public/data/jobs`, jobId);
                    await setDoc(jobRef, { deleted: true }, { merge: true }); // Soft delete simulation (better for production)
                    console.log('Job deleted:', jobId);
                } catch (error) {
                    console.error('Error deleting job:', error);
                    // Using alert here since we cannot use a full modal component
                    alert('Failed to delete job. Check console for details.');
                }
            }
        };

        // --- Event Listeners ---

        const attachItemListeners = () => {
            // Remove previous listeners to prevent duplicates
            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.removeEventListener('click', handleRemoveItem);
            });

            // Re-attach listeners
            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', handleRemoveItem);
            });
        };

        const handleRemoveItem = (event) => {
            const row = event.target.closest('.item-input-row');
            if (row) {
                // Prevent removing the last item
                if (document.querySelectorAll('.item-input-row').length > 1) {
                    row.remove();
                } else {
                    // Using alert here since we cannot use a full modal component
                    alert('A job must have at least one item.');
                }
            }
        };

        const attachJobListeners = (jobs) => {
            // Remove previous listeners
            document.querySelectorAll('.edit-job-btn').forEach(btn => btn.removeEventListener('click', handleEditClick));
            document.querySelectorAll('.delete-job-btn').forEach(btn => btn.removeEventListener('click', handleDeleteClick));
            document.querySelectorAll('.print-job-btn').forEach(btn => btn.removeEventListener('click', handlePrintClick));
            document.querySelectorAll('.job-card').forEach(card => card.removeEventListener('click', handleToggleDetails));


            // Re-attach edit listeners
            document.querySelectorAll('.edit-job-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleEditClick(e, jobs));
            });

            // Re-attach delete listeners
            document.querySelectorAll('.delete-job-btn').forEach(btn => {
                btn.addEventListener('click', handleDeleteClick);
            });

            // Re-attach print listeners
            document.querySelectorAll('.print-job-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handlePrintClick(e, jobs));
            });

            // Re-attach detail toggle listeners (click anywhere on the card to toggle details)
            document.querySelectorAll('.job-card').forEach(card => {
                card.addEventListener('click', handleToggleDetails);
            });
        };

        const handleEditClick = (e, jobs) => {
            e.stopPropagation(); // Stop click from bubbling up to the card detail toggle
            const jobId = e.currentTarget.dataset.jobId;
            const jobToEdit = jobs.find(j => j.id === jobId);
            if (jobToEdit) {
                editJob(jobToEdit);
            }
        };

        const handleDeleteClick = (e) => {
            e.stopPropagation(); // Stop click from bubbling up to the card detail toggle
            const jobId = e.currentTarget.dataset.jobId;
            deleteJob(jobId);
        };
        
        const handlePrintClick = (e, jobs) => {
            e.stopPropagation(); // Stop click from bubbling up to the card detail toggle
            const jobId = e.currentTarget.dataset.jobId;
            const jobToPrint = jobs.find(j => j.id === jobId);
            if (jobToPrint) {
                printJobReport(jobToPrint);
            }
        };

        const handleToggleDetails = (e) => {
            // Ensure the click didn't land on a button inside the card
            if (e.target.closest('button')) return;

            const card = e.currentTarget;
            const jobId = card.querySelector('.edit-job-btn').dataset.jobId;
            const details = document.querySelector(`.details-${jobId}`);
            if (details) {
                details.classList.toggle('hidden');
            }
        };


        // Primary Event Bindings
        addItemBtn.addEventListener('click', addItemInput);
        saveJobBtn.addEventListener('click', saveJob);
        cancelEditBtn.addEventListener('click', resetForm);
        authBtn.addEventListener('click', toggleAuthModal);
        closeModalBtn.addEventListener('click', toggleAuthModal);
        
        // Auth form button listeners
        signInBtn.addEventListener('click', handleSignIn);
        signUpBtn.addEventListener('click', handleSignUp);
        authForm.addEventListener('submit', handleSignIn);


        // --- Initialization ---

        window.onload = () => {
            setupFirebase();
            renderItemInputs(); // Initialize with one empty item input
        };
    </script>
</body>
</html>
