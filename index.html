import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
} from 'firebase/auth';
import { 
    getFirestore, collection, doc, onSnapshot, addDoc, 
    query, getDoc, setDoc, serverTimestamp, setLogLevel 
} from 'firebase/firestore';

// --- Firebase Initialization Variables ---
// These global variables are provided by the canvas environment.
const appId = typeof __app_id !== 'undefined' ? __app_id : 'stock-manager-app';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// The official list of roles authorized to add stock
const AUTHORIZED_ROLES = ['manager', 'dataEntry'];

// Helper function for exponential backoff (retry logic for API calls)
const retryFetch = async (fn, retries = 3, delay = 1000) => {
    for (let i = 0; i < retries; i++) {
        try {
            return await fn();
        } catch (error) {
            if (i === retries - 1) throw error;
            console.warn(`Attempt ${i + 1} failed. Retrying in ${delay}ms...`);
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2; // Exponential increase
        }
    }
};

// --- Main Application Component ---
const App = () => {
    // State for Firebase services and user data
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    
    // State for app data
    const [userRole, setUserRole] = useState('guest');
    const [stockItems, setStockItems] = useState([]);
    const [newItemName, setNewItemName] = useState('');
    const [newQuantity, setNewQuantity] = useState(0);
    const [message, setMessage] = useState('');
    const [loading, setLoading] = useState(true);

    // Determines if the current user has permission based on their loaded role
    const hasPermission = AUTHORIZED_ROLES.includes(userRole);

    // 1. Firebase Initialization and Authentication
    useEffect(() => {
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing. Cannot initialize app.");
            setLoading(false);
            return;
        }

        try {
            const firebaseApp = initializeApp(firebaseConfig);
            const firestore = getFirestore(firebaseApp);
            const firebaseAuth = getAuth(firebaseApp);
            
            setDb(firestore);
            setAuth(firebaseAuth);
            setLogLevel('debug'); // Enable detailed Firestore logging

            // Sign in logic
            const signIn = async () => {
                if (initialAuthToken) {
                    await signInWithCustomToken(firebaseAuth, initialAuthToken);
                } else {
                    await signInAnonymously(firebaseAuth);
                }
            };
            
            // Wait for authentication state
            const unsubscribe = onAuthStateChanged(firebaseAuth, (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    // This case should be rare if signIn logic works, but handles sign out.
                    setUserId(null);
                }
                setIsAuthReady(true);
            });

            // Run sign in
            signIn().catch(e => {
                console.error("Authentication failed:", e);
                setIsAuthReady(true);
            });

            return () => unsubscribe();
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            setLoading(false);
        }
    }, []);

    // 2. Fetch User Role and Stock Data (using onSnapshot)
    useEffect(() => {
        if (!isAuthReady || !db || !userId) return;

        // A. Fetch User Role
        const userRolePath = `/artifacts/${appId}/public/data/user_roles/${userId}`;
        const userRoleRef = doc(db, userRolePath);
        
        const unsubscribeRole = onSnapshot(userRoleRef, (docSnap) => {
            if (docSnap.exists()) {
                const role = docSnap.data().role;
                setUserRole(role);
                setMessage(`Role loaded: ${role}.`);
                // For demo purposes: Ensure a default role exists for the current user
            } else if (userId) {
                // If no role is found, assign a default 'customer' role for the front-end display.
                // In a real app, role assignment should happen on user creation.
                setUserRole('customer');
                setMessage('No specific role found. Defaulting to customer (no stock adding permission).');
            }
        }, (error) => {
            console.error("Error fetching user role:", error);
            setMessage('Error fetching user role. Defaulting to customer.');
            setUserRole('customer');
        });

        // B. Fetch Stock Items
        const stockCollectionPath = `/artifacts/${appId}/public/data/inventory_stock`;
        const stockRef = collection(db, stockCollectionPath);
        const unsubscribeStock = onSnapshot(stockRef, (snapshot) => {
            const items = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            // Sort by creation time (or name)
            items.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
            setStockItems(items);
            setLoading(false);
        }, (error) => {
            console.error("Error fetching stock data:", error);
            setMessage('Error loading stock inventory.');
            setLoading(false);
        });

        return () => {
            unsubscribeRole();
            unsubscribeStock();
        };

    }, [isAuthReady, db, userId]);

    // 3. Stock Addition Handler
    const handleAddStock = useCallback(async (e) => {
        e.preventDefault();
        
        if (!hasPermission) {
            setMessage('üö´ Permission Denied: Only managers and data entry personnel can add stock.');
            return;
        }

        if (newItemName.trim() === '' || parseInt(newQuantity) <= 0) {
            setMessage('Please enter a valid item name and quantity.');
            return;
        }

        setLoading(true);
        setMessage('Adding stock...');
        
        const stockCollectionPath = `/artifacts/${appId}/public/data/inventory_stock`;
        const stockRef = collection(db, stockCollectionPath);
        
        try {
            await retryFetch(() => addDoc(stockRef, {
                name: newItemName.trim(),
                quantity: parseInt(newQuantity),
                addedBy: userId,
                role: userRole,
                createdAt: serverTimestamp(),
            }));

            setMessage(`‚úÖ Successfully added ${newQuantity} x ${newItemName}.`);
            setNewItemName('');
            setNewQuantity(0);

        } catch (error) {
            console.error("Firestore write failed:", error);
            // This error is crucial: it should catch a security rule denial (Permission Denied)
            if (error.code === 'permission-denied') {
                setMessage('‚ùå Security Violation Detected: The database rule blocked this operation.');
            } else {
                setMessage(`‚ùå Failed to add stock: ${error.message}`);
            }
        } finally {
            setLoading(false);
        }
    }, [db, userId, userRole, newItemName, newQuantity, hasPermission]);


    // --- UI Rendering ---

    if (loading && !isAuthReady) {
        return <div className="flex justify-center items-center h-screen bg-gray-50">
            <div className="text-xl font-semibold text-gray-600">Loading App...</div>
        </div>
    }

    return (
        <div className="min-h-screen bg-gray-50 p-4 sm:p-8 font-inter">
            <script src="https://cdn.tailwindcss.com"></script>
            <div className="max-w-4xl mx-auto">
                
                <h1 className="text-3xl font-extrabold text-indigo-700 mb-2">
                    Role-Based Stock Manager
                </h1>
                
                <div className="text-sm font-medium text-gray-500 mb-6 p-3 bg-white shadow-lg rounded-lg border border-gray-100">
                    <p>
                        <span className="font-bold text-gray-700">Your User ID:</span> {userId || 'N/A'} 
                        (Please share this ID with your admin to set your role)
                    </p>
                    <p>
                        <span className="font-bold text-gray-700">Your Role:</span> 
                        <span className={`ml-1 px-2 py-0.5 rounded-full text-xs font-semibold ${
                            userRole === 'manager' ? 'bg-green-100 text-green-800' :
                            userRole === 'dataEntry' ? 'bg-blue-100 text-blue-800' :
                            'bg-red-100 text-red-800'
                        }`}>
                            {userRole.toUpperCase()}
                        </span>
                    </p>
                </div>
                
                {message && (
                    <div className={`p-3 rounded-lg text-sm font-medium mb-6 ${
                        message.startsWith('‚úÖ') ? 'bg-green-100 text-green-800' : 
                        message.startsWith('üö´') || message.startsWith('‚ùå') ? 'bg-red-100 text-red-800' : 
                        'bg-yellow-100 text-yellow-800'
                    }`}>
                        {message}
                    </div>
                )}


                {/* Stock Addition Form (Only visible to authorized roles) */}
                <div className="mb-8 p-6 bg-white shadow-xl rounded-xl">
                    <h2 className="text-2xl font-bold mb-4 text-gray-800">
                        {hasPermission ? 'Add New Inventory Stock' : 'Stock Addition Restricted'}
                    </h2>
                    
                    {hasPermission ? (
                        <form onSubmit={handleAddStock} className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input
                                    type="text"
                                    placeholder="Item Name (e.g., Widget-A)"
                                    value={newItemName}
                                    onChange={(e) => setNewItemName(e.target.value)}
                                    className="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 col-span-1 md:col-span-2"
                                    required
                                />
                                <input
                                    type="number"
                                    placeholder="Quantity"
                                    value={newQuantity || ''}
                                    onChange={(e) => setNewQuantity(e.target.value)}
                                    className="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    min="1"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-400 disabled:cursor-not-allowed shadow-md hover:shadow-lg"
                            >
                                {loading ? 'Processing...' : 'Add Stock to Inventory'}
                            </button>
                        </form>
                    ) : (
                        <p className="text-lg text-red-600 bg-red-50 p-4 rounded-lg border border-red-200">
                            You must be a **Manager** or **Data Entry** person to add stock. Your current role (**{userRole.toUpperCase()}**) is not authorized.
                        </p>
                    )}
                </div>

                {/* Current Stock List */}
                <div className="p-6 bg-white shadow-xl rounded-xl">
                    <h2 className="text-2xl font-bold mb-4 text-gray-800">Current Inventory Stock</h2>
                    <ul className="space-y-3">
                        {stockItems.length === 0 ? (
                            <li className="text-gray-500 italic">No stock items found.</li>
                        ) : (
                            stockItems.map((item) => (
                                <li key={item.id} className="p-4 border border-gray-200 rounded-lg shadow-sm flex justify-between items-center bg-gray-50">
                                    <div className="flex-grow">
                                        <div className="text-lg font-semibold text-gray-900">{item.name}</div>
                                        <div className="text-sm text-gray-500">
                                            Added by: {item.role} ({item.addedBy.substring(0, 8)}...)
                                        </div>
                                    </div>
                                    <div className="text-2xl font-extrabold text-indigo-600">
                                        {item.quantity}
                                    </div>
                                </li>
                            ))
                        )}
                    </ul>
                </div>

                {/* Role Setup Instructions (For testing) */}
                <div className="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
                    <h3 className="font-bold text-base mb-2">Testing Note: How to Authorize a User</h3>
                    <p>To test the authorization, you must manually set the user's role in the Firestore database:</p>
                    <ol className="list-decimal list-inside ml-2 mt-1 space-y-1">
                        <li>Navigate to the collection path: <code className="bg-yellow-100 px-1 rounded">artifacts/{appId}/public/data/user_roles</code></li>
                        <li>Create a new document with the ID: **Your User ID** shown above.</li>
                        <li>Set the field <code className="bg-yellow-100 px-1 rounded">role</code> to either <code className="bg-yellow-100 px-1 rounded">manager</code> or <code className="bg-yellow-100 px-1 rounded">dataEntry</code>.</li>
                        <li>Save the document and refresh the app. Your permissions will update automatically.</li>
                    </ol>
                </div>

            </div>
        </div>
    );
};

export default App;
